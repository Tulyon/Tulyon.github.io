
<!DOCTYPE html>
<html lang="" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title></title>

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="一整个宇宙，换一颗红豆。

"> 
    <meta name="author" content="John Doe"> 
    <link rel="alternative" href="atom.xml" title="" type="application/atom+xml"> 
    <link rel="icon" href="/img/favicon.png"> 
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
    <link rel="stylesheet" href="/css/diaspora.css">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({
        google_ad_client: "ca-pub-8691406134231910",
        enable_page_level_ads: true
      });
    </script>

</head>

<body class="loading">
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="icon-home image-icon" href="javascript:;"></a>
    <div title="播放/暂停" class="icon-play"></div>
    <h3 class="subtitle">原生JS+HTML+CSS打造大文件上传</h3>
    <div class="social">
        <!--<div class="like-icon">-->
            <!--<a href="javascript:;" class="likeThis active"><span class="icon-like"></span><span class="count">76</span></a>-->
        <!--</div>-->
        <div>
            <div class="share">
                <a title="获取二维码" class="icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>
    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">原生JS+HTML+CSS打造大文件上传</h1>
        <div class="stuff">
            <span>八月 10, 2018</span>
            
  <ul class="post-tags-list"><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/个人/">个人</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/原创/">原创</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/图拉扬的博客/">图拉扬的博客</a></li><li class="post-tags-list-item"><a class="post-tags-list-link" href="/tags/记录/">记录</a></li></ul>


        </div>
        <div class="content markdown">
            <p><img src="/article-img/file/a.jpg" alt=""></p>
<blockquote>
<p>找个天台喝酒，也是极好的，北亭也行。</p>
</blockquote>
<p>在正式开始之前，首先我们来胡侃几句，想跳过的同学也可以直接进入正题。</p>
<p>在前不久接触过的一个小项目中，有这么一个需求，移动端需要上传一段相关的视频，时间长度限制在3min之内，虽说3分钟的视频不是很长，但一些比较高清的设备拍摄出来，文件也是相当的大，好几百M完全不为过，那时候没有什么意识，甭管大文件小文件，不就是上传吗，上去就是一梭子，于问题就来了：</p>
<ul>
<li>几百M的文件，直接就传过去，服务器没有的文件我给传过去了，服务器有的文件还是传过去了，耗时耗力；</li>
<li>搞了个sha256来计算文件指纹，实现文件秒传，于是好几百M的文件一下子拿到内存中去计算，浏览器闪退了；</li>
<li>好不容易开始上传了，结果什么动静反馈都没有，也不知道传了多少，还需要传多少；</li>
<li>等了半天，发现网络又卡了，想暂停一下大文件的上传，先给小的传完，抱歉暂不支持该服务，充会员也不行；</li>
<li>耐着性子传到了99%，结果手机没电了关机了，一开机——抱歉，您还得重新来过；</li>
</ul>
<p>所以造成用户体验相当不好，那么接下来我们就正式进入主题。</p>
<p><img src="/article-img/file/sp.png" alt=""></p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>大文件上传需要提供哪些功能呢？或者说，我们要做到什么程度才能保证大文件上传的可用性呢？下面是我个人总结的一些点：</p>
<ol>
<li>服务器已有的文件不需要再上传，支持秒传；</li>
<li>计算文件指纹时，不能给内存造成太大的压力，支持分片计算；</li>
<li>交互友好，及时反馈信息，支持实时读取进度，支持实时上传；</li>
<li>记录上传信息，支持暂停/继续等断点续传功能；</li>
</ol>
<p>当然上面只是一些比较基础的功能，大家也可以继续再补充下去。</p>
<p><img src="/article-img/file/sp.png" alt="">    </p>
<h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><p>在开始长篇大论之前，我们来看一下我们需要做的东西到底长什么样，这样会更直观一些；</p>
<p>首先上传一个服务器没有的文件：</p>
<video src="/article-img/file/大文件分片上传.mp4" controls="controls" style="max-width: 100%; display: block; margin-left: auto; margin-right: auto;" width="100%" height="100%"> your browser does not support the video tag </video>

<p><img src="/article-img/file/ssp.png" alt="">    </p>
<p>该文件大小为600多M，但是在计算文件指纹的时候，内存并无明显波动，即没有对内存造成太大的压力，且读取进度与上传进度都是实时计算的，支持暂停/继续这样的断点续传功能；</p>
<p>下面我们来上传一个服务器已有的文件来看一下文件秒传功能：</p>
<video src="/article-img/file/大文件秒传.mp4" controls="controls" style="max-width: 100%; display: block; margin-left: auto; margin-right: auto;" width="100%" height="100%"> your browser does not support the video tag </video>

<p><img src="/article-img/file/ssp.png" alt="">    </p>
<p>上面可以看到，这个128M的视频文件，由于服务器已存在，所以不需要再上传以节约资源，直接推进进度即可；</p>
<p>一开始我在设计分析的时候，其实是比较乱的，网上查找到的一些资料，有一部分是推荐现已有的插件，还有的我个人觉得并不那么符合我的设计，毕竟每个人的想法都有些不同；于是干脆就花了一点的时间去梳理总结自己的思路：</p>
<p><img src="/article-img/file/大文件上传流程图.png" alt=""></p>
<p><img src="/article-img/file/sp.png" alt="">    </p>
<p>上面是前端的流程图，下面我们来看一下后端的：</p>
<p><img src="/article-img/file/大文件上传后端.png" alt=""></p>
<p>上面的两幅图就是我个人在设计时候的一些思路，有的地方也可以采取其他的一些方法，希望我们多多去尝试一下不同的解决方案；</p>
<p>总体思路有了，那么接下来我们需要实现我们的想法了；</p>
<h2 id="前端代码实现"><a href="#前端代码实现" class="headerlink" title="前端代码实现"></a>前端代码实现</h2><p>这一部分我们来看一下具体的代码实现。</p>
<h3 id="一-HTML代码"><a href="#一-HTML代码" class="headerlink" title="一 HTML代码"></a>一 HTML代码</h3><p>首先是一些主要的样式，主要的样式效果以及相关的代码参考如下：</p>
<p></p><p data-height="400" data-theme-id="dark" data-slug-hash="PdWGod" data-default-tab="result" data-user="tulyon" data-pen-title="PdWGod" class="codepen">See the Pen <a href="https://codepen.io/tulyon/pen/PdWGod/" target="_blank" rel="noopener">PdWGod</a> by e2e test (<a href="https://codepen.io/tulyon" target="_blank" rel="noopener">@tulyon</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.</p><p></p>
<script async src="https://static.codepen.io/assets/embed/ei.js"></script>

<p>那么我则在上面的基础上，根据实际需要添加或修改了一些东西，html代码如下：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">id</span>=<span class="string">"svgloader"</span> <span class="attr">class</span>=<span class="string">"svg--template loader"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">circle</span> <span class="attr">id</span>=<span class="string">"prgcircle"</span> <span class="attr">class</span>=<span class="string">"circle1"</span> <span class="attr">stroke</span>=<span class="string">"none"</span> <span class="attr">stroke-width</span>=<span class="string">"4"</span> <span class="attr">fill</span>=<span class="string">"none"</span> <span class="attr">r</span>=<span class="string">"24"</span> <span class="attr">cx</span>=<span class="string">"25"</span> <span class="attr">cy</span>=<span class="string">"25"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">svg</span> <span class="attr">id</span>=<span class="string">"checkmark"</span> <span class="attr">class</span>=<span class="string">"svg--template checkmark"</span> <span class="attr">viewBox</span>=<span class="string">"0 0 50 50"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">g</span> <span class="attr">class</span>=<span class="string">"checkmark1"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"line1"</span> <span class="attr">d</span>=<span class="string">"M20.8,36l-4,4c-0.7,0.7-1.7,0.7-2.4,0L0.8,26.4c-0.7-0.7-0.7-1.7,0-2.4l4-4c0.7-0.7,1.7-0.7,2.4,0l13.6,13.6</span></span></span><br><span class="line"><span class="tag"><span class="string">            C21.5,34.3,21.5,35.4,20.8,36z"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">path</span> <span class="attr">class</span>=<span class="string">"line2"</span> <span class="attr">d</span>=<span class="string">"M14.5,39.9l-4-4c-0.7-0.7-0.7-1.7,0-2.4L43.4,0.6c0.7-0.7,1.7-0.7,2.4,0l4,4c0.7,0.7,0.7,1.7,0,2.4L16.9,39.9</span></span></span><br><span class="line"><span class="tag"><span class="string">            C16.3,40.6,15.2,40.6,14.5,39.9z"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">g</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">svg</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"inputdiv"</span> <span class="attr">style</span>=<span class="string">"position: relative;"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">"fileinput"</span> <span class="attr">class</span>=<span class="string">"btnSubmit"</span> <span class="attr">type</span>=<span class="string">"file"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">label</span> <span class="attr">id</span>=<span class="string">"fileLabel"</span> <span class="attr">for</span>=<span class="string">"fileinput"</span> <span class="attr">class</span>=<span class="string">"fileLabel btnSubmit"</span> &gt;</span>请选择文件 <span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">span</span> <span class="attr">id</span>=<span class="string">"player"</span> <span class="attr">class</span>=<span class="string">"pause"</span>&gt;</span><span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span> <span class="attr">id</span>=<span class="string">"tiptext"</span> <span class="attr">class</span>=<span class="string">"tip"</span>&gt;</span>读取中...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里涉及到了一些svg制作进度条的知识点，由于篇幅原因，具体相关的就不一一展开了，以后有机会我们再来研究一下这些比较好玩有趣的样式，文章主要是聊聊大文件上传，一些svg相关的内容还有样式可以参考如下一些文章：</p>
<p><a href="https://moxo.io/blog/2017/07/22/svg-circular-animation/" target="_blank" rel="noopener">笔记：SVG 环形动画（进度条）原理</a> </p>
<p><a href="https://www.uis.cc/2014/04/23/Creating-a-round-progress-button-with-SVG/" target="_blank" rel="noopener">如何创建一个圆形进度按钮 SVG</a> </p>
<p><a href="http://wow.techbrood.com/fiddle/28577" target="_blank" rel="noopener">SVG 自带环形进度条的提交按钮</a> </p>
<p><img src="/article-img/file/ssp.png" alt="">    </p>
<h3 id="二-Javascript-代码"><a href="#二-Javascript-代码" class="headerlink" title="二 Javascript 代码"></a>二 Javascript 代码</h3><h4 id="1-事件绑定"><a href="#1-事件绑定" class="headerlink" title="1. 事件绑定"></a>1. 事件绑定</h4><p>首先绑定事件：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> quence = <span class="keyword">new</span> <span class="built_in">Array</span>()          <span class="comment">// 待上传的任务队列</span></span><br><span class="line"><span class="keyword">let</span> uploaderAry = [];             <span class="comment">// 上传器队列</span></span><br><span class="line"><span class="keyword">let</span> observer = <span class="keyword">new</span> Observer();    <span class="comment">// 观察者</span></span><br><span class="line"><span class="keyword">let</span> pauseEventSta = <span class="literal">true</span>;         <span class="comment">// 暂停/继续事件的状态控制</span></span><br><span class="line"></span><br><span class="line">eventUtil.addEventHandler(inputFile, <span class="string">'change'</span>, changeFile, <span class="literal">false</span>);</span><br><span class="line">eventUtil.addEventHandler(player, <span class="string">'click'</span>, clickPlayer, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 选择文件</span></span><br><span class="line"><span class="comment"> * @param &#123;Event&#125; event 事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">changeFile</span>(<span class="params">event</span>) </span>&#123;          <span class="comment">// 选择文件函数</span></span><br><span class="line">    <span class="keyword">if</span> (!event.target.files[<span class="number">0</span>]) &#123;       <span class="comment">// 没有选择任何文件</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> file = event.target.files[<span class="number">0</span>];</span><br><span class="line">    showPrgCircle()         <span class="comment">// 调整样式，显示圆形进度条，不影响逻辑理解</span></span><br><span class="line">    setTimeout(timerFunc(getFileHash, file), <span class="number">600</span>);      <span class="comment">// 延迟600ms再计算文件指纹，配合动画效果</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 提供setTimeout异步调用的传参功能</span></span><br><span class="line"><span class="comment"> * @param &#123;Function&#125; asyncFunc  setTimeout异步调用的函数</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; param  异步调用的函数参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">timerFunc</span>(<span class="params">asyncFunc, ...param</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        asyncFunc(...param);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的<code>showPrgCircle</code> 函数只是设置一些相关样式，不影响主要逻辑的理解；</p>
<p>这里设计到的一个知识点是事件绑定，我这里采用的是DOM2级事件处理，为了兼容IE8及其以下版本，我封装了一个事件绑定函数：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> eventUtil = &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加事件处理程序</span></span><br><span class="line"><span class="comment">     * @param &#123;HTMLElement&#125;    ele            需要绑定的元素</span></span><br><span class="line"><span class="comment">     * @param &#123;string&#125;         type           事件类型名称</span></span><br><span class="line"><span class="comment">     * @param &#123;function&#125;       handler        事件处理函数</span></span><br><span class="line"><span class="comment">     * @param &#123;boolean&#125;        useCapture     是否使用捕获, 仅对addEventListener使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    addEventHandler: <span class="function"><span class="keyword">function</span> (<span class="params">ele, type, handler, useCapture</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!ele || !type || !handler) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            useCapture = useCapture ? useCapture : <span class="literal">false</span>;</span><br><span class="line">            ele.addEventListener(type, handler, useCapture);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                ele.attachEvent(<span class="string">'on'</span> + type, handler);</span><br><span class="line">            &#125;<span class="keyword">catch</span>&#123;</span><br><span class="line">                ele[<span class="string">'on'</span> + type] = handler;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 添加事件处理程序</span></span><br><span class="line"><span class="comment">     * @param &#123;HTMLElement&#125;    ele            需要绑定的元素</span></span><br><span class="line"><span class="comment">     * @param &#123;string&#125;         type           事件类型名称</span></span><br><span class="line"><span class="comment">     * @param &#123;function&#125;       handler        事件处理函数</span></span><br><span class="line"><span class="comment">     * @param &#123;boolean&#125;        useCapture     是否使用捕获, 仅对addEventListener使用</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    removeEventHandler: <span class="function"><span class="keyword">function</span> (<span class="params">ele, type, handler, useCapture</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!ele || !type || !handler) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            useCapture = useCapture ? useCapture : <span class="literal">false</span>;</span><br><span class="line">            ele.removeEventListener(type, handler, useCapture);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(e) &#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                ele.detachEvent(type, handler);</span><br><span class="line">            &#125;<span class="keyword">catch</span>&#123;</span><br><span class="line">                ele[<span class="string">'on'</span> + type] = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="2-计算文件指纹"><a href="#2-计算文件指纹" class="headerlink" title="2. 计算文件指纹"></a>2. 计算文件指纹</h4><p>接下来我们再来看一下如何计算文件指纹：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 计算文件指纹</span></span><br><span class="line"><span class="comment"> * @param &#123;File&#125; file 待计算文件指纹的文件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getFileHash</span>(<span class="params">file</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> fileSize = file.size;</span><br><span class="line">    <span class="keyword">let</span> chunkSize = <span class="number">2</span> * <span class="number">1024</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">let</span> fileReader = <span class="keyword">new</span> FileReader();</span><br><span class="line">    <span class="keyword">let</span> hash = sha256.create();</span><br><span class="line">    <span class="keyword">let</span> fileId = <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">let</span> tipText = <span class="built_in">document</span>.getElementById(<span class="string">'tiptext'</span>)</span><br><span class="line">    tipText.style.visibility = <span class="string">'visible'</span>;    <span class="comment">// 显示读取进度提示</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fileSize &lt; chunkSize) &#123;  <span class="comment">// 文件大小小于分片阈值</span></span><br><span class="line">        fileReader.readAsArrayBuffer(file);</span><br><span class="line">        fileReader.onprogress = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">            tipText.innerText = <span class="string">'读取中...'</span> + <span class="built_in">Math</span>.round(e.loaded / e.total * <span class="number">100</span>) + <span class="string">'%'</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        fileReader.onloadend = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            hash.update(fileReader.result);</span><br><span class="line">            fileId = hash.hex();</span><br><span class="line">            <span class="keyword">let</span> task = &#123;       <span class="comment">// 封装成task</span></span><br><span class="line">                file: file,</span><br><span class="line">                fileId: fileId,</span><br><span class="line">                chunkSta: <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            quence.push(task);    <span class="comment">// 入列</span></span><br><span class="line">            tipText.style.visibility = <span class="string">'hidden'</span>;</span><br><span class="line">            queryFileId(fileId);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 文件大于阈值, 进行分片处理</span></span><br><span class="line">        <span class="keyword">let</span> chunkSum = <span class="built_in">Math</span>.ceil(fileSize / chunkSize);    <span class="comment">// 求出分片总数, 向上取整</span></span><br><span class="line">        <span class="keyword">let</span> currentChunk = <span class="number">0</span>;    <span class="comment">// 指向当前片</span></span><br><span class="line">        <span class="keyword">let</span> startIndex = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">let</span> endIndex = startIndex + chunkSize &gt; fileSize ? fileSize : startIndex + chunkSize;</span><br><span class="line">        <span class="keyword">let</span> chunkAry = [];     <span class="comment">// 所有需要上传的块序号</span></span><br><span class="line"></span><br><span class="line">        fileReader.readAsArrayBuffer(file.slice(startIndex, endIndex));</span><br><span class="line">        fileReader.onloadend = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            hash.update(fileReader.result);    <span class="comment">// 更新sha256</span></span><br><span class="line">            chunkAry.push(currentChunk);     <span class="comment">// 块号入列</span></span><br><span class="line">            <span class="keyword">let</span> task = &#123;      <span class="comment">// 封装成task</span></span><br><span class="line">                file: file,</span><br><span class="line">                chunkSta: <span class="literal">true</span>,</span><br><span class="line">                currentChunk: currentChunk,</span><br><span class="line">                chunkData: &#123;</span><br><span class="line">                    startIndex: startIndex,</span><br><span class="line">                    endIndex: endIndex,</span><br><span class="line">                &#125;,</span><br><span class="line">                totalChunks: chunkSum,</span><br><span class="line">            &#125;</span><br><span class="line">            quence.push(task);     <span class="comment">// 入列</span></span><br><span class="line">            currentChunk++;</span><br><span class="line">            <span class="comment">// currentChunk从0开始计数, 自增后再进行进度处理</span></span><br><span class="line">            <span class="keyword">let</span> readPercent = currentChunk / chunkSum;      </span><br><span class="line">            tipText.innerText = <span class="string">'读取中...'</span> + <span class="built_in">Math</span>.round(readPercent * <span class="number">100</span>) + <span class="string">'%'</span>;</span><br><span class="line">            <span class="keyword">if</span> (currentChunk &lt; chunkSum) &#123;      <span class="comment">// 还有分片需要处理</span></span><br><span class="line">                startIndex = currentChunk * chunkSize;</span><br><span class="line">                endIndex = startIndex + chunkSize &gt; fileSize ? fileSize : startIndex + chunkSize;</span><br><span class="line">                fileReader.readAsArrayBuffer(file.slice(startIndex, endIndex));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 所有分片已处理完</span></span><br><span class="line">                fileId = hash.hex();</span><br><span class="line">                quence.forEach(<span class="function">(<span class="params">curTask</span>) =&gt;</span> &#123;</span><br><span class="line">                    curTask.fileId = fileId;        <span class="comment">// 记录文件指纹</span></span><br><span class="line">                    curTask.chunkAry = chunkAry;    <span class="comment">// 所有需要上传的块序号</span></span><br><span class="line">                &#125;)</span><br><span class="line">                tipText.style.visibility = <span class="string">'hidden'</span>;</span><br><span class="line">                queryFileId(fileId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中，首先我们用到了一个bootCDN的hash函数，它提供一个分片计算功能，也就给我们提供了比较大的帮助，具体内容可以参考：<a href="https://www.bootcdn.cn/js-sha256/" target="_blank" rel="noopener">js-sha256</a> ；</p>
<p>当文件大小小于切片阈值的时候，我们使用 <code>fileReader.onprogress</code> 来处理<code>progress</code>事件并来计算单片的读取进度，我这里分片的阈值是2M，如果问为什么是2M而不是5M/10M/…，因为我这里也仅仅是举个简单的例子，我还没有时间去仔细研究到底切片的阈值是多少比较合理，在实际的开发中我们也许可以根据实际情况来进行取舍；</p>
<p>回到正题，当文件大小大于切片阈值时，我们就需要切片了，这里我们用到的是一个File.slice方法将文件进行分割成二进制Blob对象 ，下面简单介绍一下：</p>
<blockquote>
<h4 id="Bolb对象"><a href="#Bolb对象" class="headerlink" title="Bolb对象"></a>Bolb对象</h4><p><code>Blob</code> 对象表示一个不可变、原始数据的类文件对象。 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/File" target="_blank" rel="noopener"><code>File</code></a> 接口基于<code>Blob</code>，继承了 blob 的功能并将其扩展使其支持用户系统上的文件。</p>
<h4 id="Blob-slice"><a href="#Blob-slice" class="headerlink" title="Blob.slice()"></a>Blob.slice()</h4><p><code>方法介绍</code>：属于Blob对象的一个方法,而File对象是继承Blob对象的,因此File对象也含有slice方法 </p>
<p><code>参数介绍</code>：</p>
<ul>
<li><code>start</code>  ：这个参数代表 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 里的下标，表示第一个会被会被拷贝进新的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 的字节的起始位置。 </li>
<li><code>end</code>  ：这个参数代表的是 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 的一个下标 。这个下标-1的对应的字节将会是被拷贝进新的<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 的最后一个字节。 </li>
<li><code>contentType</code>  ：给新的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="noopener"><code>Blob</code></a> 赋予一个新的文档类型。这将会把它的 type 属性设为被传入的值。它的默认值是一个空的字符串。 </li>
</ul>
</blockquote>
<p>利用这种方式，我们可以每次将一定大小的文件内容读入内存中，而不至于将几百M甚至是几G的文件一次性读进内存中；</p>
<p>每读完一个分片，我们需要更新一下hash值：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hash.update(fileReader.result);    <span class="comment">// 更新sha256</span></span><br></pre></td></tr></table></figure>
<p>然后更新读取进度，这里我采取的方法是每读完一个分片再去计算读取进度，计算公式是：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">读取进度 = 已读取的分片数 / 总分片数</span><br></pre></td></tr></table></figure>
<p>接下来就是封装成一个task，并把它放入任务队列中，至于为什么这么做呢，看下去就明白了：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> task = &#123;      <span class="comment">// 封装成task</span></span><br><span class="line">    file: file,</span><br><span class="line">    chunkSta: <span class="literal">true</span>,</span><br><span class="line">    currentChunk: currentChunk,</span><br><span class="line">    chunkData: &#123;</span><br><span class="line">        startIndex: startIndex,</span><br><span class="line">        endIndex: endIndex,</span><br><span class="line">    &#125;,</span><br><span class="line">    totalChunks: chunkSum,</span><br><span class="line">&#125;</span><br><span class="line">quence.push(task);     <span class="comment">// 入列</span></span><br></pre></td></tr></table></figure>
<p>可能有读者留意到有这么两行代码：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> chunkAry = [];     <span class="comment">// 所有需要上传的块序号</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">chunkAry.push(currentChunk);     <span class="comment">// 块号入列</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">curTask.chunkAry = chunkAry;    <span class="comment">// 所有需要上传的块序号</span></span><br></pre></td></tr></table></figure>
<p>为什么task还要带上所有分片的序号呢？我这里的想法是为了做断点续传做准备，我们把每个片的序号放入一个数组中并发送出去，后端拿到这个数组后，就知道这次我要接收的分片是哪些，每接收到一个分片，就将数组中对应的序号删除，剩下的就是待接收的分片，即后端可以再通过返回该数组，来告知前端我还需要接收哪些片段，而不必再重新上传；</p>
<h4 id="3-查询文件状态"><a href="#3-查询文件状态" class="headerlink" title="3. 查询文件状态"></a>3. 查询文件状态</h4><p>等所有的分片读取并计算完毕之后，我们将计算出的文件指纹发送到后端去查询，看一下文件是否有对应的记录：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 查询文件存在状态</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; fileId 文件指纹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queryFileId</span>(<span class="params">fileId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> prgcircle = <span class="built_in">document</span>.getElementById(<span class="string">'prgcircleCopy'</span>);</span><br><span class="line">    prgcircle.style.opacity = <span class="number">1</span>;   <span class="comment">// 样式调节</span></span><br><span class="line">    ajax(&#123;</span><br><span class="line">        method: <span class="string">'GET'</span>,</span><br><span class="line">        url: <span class="string">'http://localhost:3000/'</span>,</span><br><span class="line">        <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">        data: &#123; <span class="attr">fileId</span>: fileId &#125;,</span><br><span class="line">        dataType: <span class="string">'json'</span>,</span><br><span class="line">        success: <span class="function">(<span class="params">resp</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (resp.fileExistSta === <span class="literal">true</span>) &#123;          <span class="comment">// 返回true, 表示文件指纹存在, 秒传</span></span><br><span class="line">                prgcircle.style.strokeDashoffset = <span class="number">0</span>;  <span class="comment">// 设置偏移量为0, 即进度条加满</span></span><br><span class="line">                setSuccessStyle()    <span class="comment">// 样式设置</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                createUploader(resp.fileExistSta)       <span class="comment">// 文件不存在/未完全上传完毕, 准备上传</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，我们刚刚那个存放分片序号的数组就派上用场了，查询文件指纹的API返回三种结果：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="string">"fileExistSta"</span>:<span class="literal">true</span>&#125; --------------- 文件已存在</span><br><span class="line">&#123;<span class="string">"fileExistSta"</span>:<span class="literal">false</span>&#125; -------------- 文件不存在</span><br><span class="line">&#123;<span class="string">"fileExistSta"</span>:[<span class="string">"11"</span>,<span class="string">"12"</span>,<span class="string">"15"</span>,<span class="string">"17"</span>,<span class="string">"19"</span>]&#125; ------------- 文件已部分上传，数组内为待上传的分片序号</span><br></pre></td></tr></table></figure>
<p>根据服务器的返回，我们可以采取下一步动作，如果文件已存在，那我们也就不必再重新上传文件，直接推进进度，实现秒传；如果文件不存在，那我们就需要开始准备上传工作了；</p>
<p>这里我还简单封装了一个ajax：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 封装Ajax函数</span></span><br><span class="line"><span class="comment"> * @param &#123;Object&#125; options </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ajax</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 检查</span></span><br><span class="line">    options = options || &#123;&#125;;</span><br><span class="line">    options.method = (options.method || <span class="string">'GET'</span>).toUpperCase();</span><br><span class="line">    options.url = options.url || <span class="string">''</span>;</span><br><span class="line">    options.async = options.async || <span class="literal">true</span>;</span><br><span class="line">    options.data = options.data || &#123;&#125;;</span><br><span class="line">    options.dataType = options.dataType || <span class="string">'json'</span>;</span><br><span class="line">    options.success = options.success || <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="built_in">console</span>.log(<span class="string">'success!'</span>) &#125;;</span><br><span class="line">    <span class="keyword">let</span> params = options.method === <span class="string">'GET'</span> ? formatParams(options.data) : options.data;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建XMLHttpRequest对象</span></span><br><span class="line">    <span class="keyword">let</span> xhr = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">window</span>.XMLHttpRequest) &#123;            <span class="comment">// 非IE6</span></span><br><span class="line">        xhr = <span class="keyword">new</span> XMLHttpRequest();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                                <span class="comment">// IE6及其以下版本浏览器  </span></span><br><span class="line">        xhr = <span class="keyword">new</span> ActiveXObject(<span class="string">'Microsoft.XMLHTTP'</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上传事件</span></span><br><span class="line">    xhr.upload.onprogress = <span class="function"><span class="keyword">function</span> <span class="title">fb</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (options.progress &amp;&amp; e.lengthComputable) &#123;</span><br><span class="line">            options.progress(e.loaded, e.total);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 连接与发送</span></span><br><span class="line">    <span class="keyword">switch</span> (options.method) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'GET'</span>:</span><br><span class="line">            xhr.open(options.method, options.url + <span class="string">'?'</span> + params, options.async);</span><br><span class="line">            xhr.send(<span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'POST'</span>:</span><br><span class="line">            xhr.open(options.method, options.url, options.async);</span><br><span class="line">            xhr.send(options.data);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'请设置method为GET/POST'</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    xhr.onload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (xhr.status === <span class="number">200</span>) &#123;</span><br><span class="line">            <span class="keyword">let</span> resp = <span class="built_in">JSON</span>.parse(xhr.responseText);</span><br><span class="line">            options.success(resp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 格式化参数</span></span><br><span class="line"><span class="comment">     * @param &#123;*&#125; data </span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">formatParams</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">let</span> arr = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">in</span> data) &#123;</span><br><span class="line">            <span class="comment">// 编码</span></span><br><span class="line">            <span class="keyword">let</span> encodeParams = <span class="built_in">encodeURIComponent</span>(name) + <span class="string">'='</span> + <span class="built_in">encodeURIComponent</span>(data[name])</span><br><span class="line">            arr.push(encodeParams);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 添加随机参数, 避免缓存</span></span><br><span class="line">        <span class="keyword">let</span> version = (<span class="string">'v='</span> + <span class="built_in">Math</span>.random()).replace(<span class="string">','</span>, <span class="string">''</span>);</span><br><span class="line">        arr.push(version);</span><br><span class="line">        <span class="keyword">return</span> arr.join(<span class="string">'&amp;'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们看一下<code>xhr.upload.onprogress</code> ，XHR2规范草案定义了进度事件Progress Events规范 ，遵照这个规范的浏览器中，XMLHttpRequest对象有upload属性，upload属性值是一个对象，它定义一些相关的progress事件，如<code>load</code> ，<code>loadstart</code>， <code>progress</code>，<code>loadend</code>， <code>timeout</code> 等进度事件；</p>
<h4 id="4-正式上传"><a href="#4-正式上传" class="headerlink" title="4. 正式上传"></a>4. 正式上传</h4><p>回到正题，如果文件不存在或者未完全上传完毕，那我们需要开始上传工作：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生产创建上传器</span></span><br><span class="line"><span class="comment"> * @param &#123;*&#125; fileExistSta 文件上传状态 false--文件不存在, ["11","12"]--待上传分片序号</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createUploader</span>(<span class="params">fileExistSta</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (fileExistSta) &#123;     <span class="comment">// 还需要上传的块号数组</span></span><br><span class="line">        quence = quence.filter(<span class="function">(<span class="params">curVal, index</span>) =&gt;</span> &#123;        <span class="comment">// 使用filter方法</span></span><br><span class="line">            <span class="keyword">if</span> (fileExistSta.indexOf(curVal.currentChunk.toString()  ) !== <span class="number">-1</span>) &#123;       <span class="comment">// 将quence队列中还需要上传的任务挑选出来</span></span><br><span class="line">                <span class="keyword">return</span> curVal;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> quenceLen = quence.length;   <span class="comment">// 任务总数</span></span><br><span class="line">    <span class="keyword">let</span> uploaderSum = (quenceLen &gt;= <span class="number">1</span>) &amp;&amp; (quenceLen &lt; <span class="number">5</span>) ? <span class="number">1</span> : <span class="number">5</span>;  <span class="comment">// 根据情况决定上传器的数量</span></span><br><span class="line">    <span class="keyword">let</span> uploaderData = &#123;</span><br><span class="line">        finLoadedChunks: <span class="number">0</span>,               <span class="comment">// 已经成功上传的分片数</span></span><br><span class="line">        totalChunks: quenceLen,</span><br><span class="line">        finUploaders: <span class="number">0</span>,                  <span class="comment">// 已经完成任务队列的上传器数目</span></span><br><span class="line">        totalUploaders: uploaderSum,      <span class="comment">// 总的上传器数目</span></span><br><span class="line">        setSuccessSta: <span class="literal">true</span>,              <span class="comment">// 检查到所有任务完成后, 交给最后一个上传器处理接下来的操作即可</span></span><br><span class="line">        setSuccessStyle: setSuccessStyle,</span><br><span class="line">        pauseEvent: <span class="function"><span class="keyword">function</span> (<span class="params">sta</span>) </span>&#123;</span><br><span class="line">            pauseEventSta = sta;</span><br><span class="line">            <span class="keyword">if</span> (sta) &#123;    <span class="comment">// 继续事件, 执行回调</span></span><br><span class="line">                <span class="keyword">this</span>.successFb.call(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ChunkUploader.prototype.uploaderData = uploaderData;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; uploaderSum; i++) &#123;   <span class="comment">// 外层for循环创建上传器</span></span><br><span class="line">        <span class="keyword">let</span> uploader = <span class="keyword">new</span> ChunkUploader();</span><br><span class="line">        <span class="keyword">let</span> taskQue = [];</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">let</span> j = <span class="number">0</span>; j &lt; quenceLen; j++) &#123;   <span class="comment">// 内层for循环分配对应任务</span></span><br><span class="line">            <span class="keyword">if</span> (j % uploaderSum === i) &#123;</span><br><span class="line">                taskQue.push(quence[j]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        uploader.getTask(taskQue);</span><br><span class="line">        uploaderAry.push(uploader);</span><br><span class="line">    &#125;</span><br><span class="line">    uploaderAry.forEach(<span class="function">(<span class="params">curUploader</span>) =&gt;</span> &#123;</span><br><span class="line">        curUploader.upload();</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上传器构造函数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ChunkUploader</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> player = <span class="built_in">document</span>.getElementById(<span class="string">'player'</span>);</span><br><span class="line">    <span class="keyword">let</span> prgcircle = <span class="built_in">document</span>.getElementById(<span class="string">'prgcircleCopy'</span>);</span><br><span class="line">    <span class="keyword">let</span> quenceLen = quence.length;</span><br><span class="line">    <span class="keyword">this</span>.taskIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.upload = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        ajax(&#123;</span><br><span class="line">            method: <span class="string">'POST'</span>,</span><br><span class="line">            url: <span class="string">'http://localhost:3000/'</span>,</span><br><span class="line">            <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">            data: <span class="keyword">this</span>.buildFormData(<span class="keyword">this</span>.taskQue[<span class="keyword">this</span>.taskIndex]),</span><br><span class="line">            progress: quenceLen === <span class="number">1</span> ? <span class="keyword">this</span>.progressFb : <span class="literal">null</span>,</span><br><span class="line">            success: <span class="keyword">this</span>.successFb</span><br><span class="line">        &#125;)</span><br><span class="line">        player.style.visibility = <span class="string">'visible'</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    observer.subscribe(<span class="string">'pauseEvent'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">sta</span>) </span>&#123;</span><br><span class="line">        uploaderAry.forEach(<span class="function">(<span class="params">curUploader</span>) =&gt;</span> &#123;</span><br><span class="line">            curUploader.uploaderData.pauseEvent.call(curUploader, sta)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 单片的进度处理</span></span><br><span class="line"><span class="comment">     * @param &#123;number&#125; loaded   已上传的字节数</span></span><br><span class="line"><span class="comment">     * @param &#123;number&#125; total    总字节数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>.progressFb = <span class="function">(<span class="params">loaded, total</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> uploadPercent = loaded / total;</span><br><span class="line">        prgcircle.style.strokeDashoffset = <span class="number">157</span> * (<span class="number">1</span> - uploadPercent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 成功上传完一片之后的回调</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>.successFb = <span class="function"><span class="params">()</span> =&gt;</span> &#123;   </span><br><span class="line">        <span class="keyword">if</span> (!pauseEventSta) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (quenceLen &gt; <span class="number">1</span>) &#123;   <span class="comment">// 多个片段的进度处理情况</span></span><br><span class="line">            <span class="keyword">this</span>.uploaderData.finLoadedChunks++;</span><br><span class="line">            <span class="keyword">let</span> uploadPercent = <span class="keyword">this</span>.uploaderData.finLoadedChunks / <span class="keyword">this</span>.uploaderData.totalChunks;</span><br><span class="line">            prgcircle.style.strokeDashoffset = <span class="number">157</span> * (<span class="number">1</span> - uploadPercent);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.taskIndex++;</span><br><span class="line">        <span class="keyword">let</span> task = <span class="keyword">this</span>.taskQue[<span class="keyword">this</span>.taskIndex];</span><br><span class="line">        <span class="keyword">if</span> (task) &#123;</span><br><span class="line">            ajax(&#123;</span><br><span class="line">                method: <span class="string">'POST'</span>,</span><br><span class="line">                url: <span class="string">'http://localhost:3000/'</span>,</span><br><span class="line">                <span class="keyword">async</span>: <span class="literal">true</span>,</span><br><span class="line">                data: <span class="keyword">this</span>.buildFormData(<span class="keyword">this</span>.taskQue[<span class="keyword">this</span>.taskIndex]),</span><br><span class="line">                success: <span class="keyword">this</span>.successFb</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.uploaderData.finUploaders++;    <span class="comment">// 已完成任务队列的上传器 +1</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.uploaderData.finUploaders === <span class="keyword">this</span>.uploaderData.totalUploaders &amp;&amp; <span class="keyword">this</span>.uploaderData.setSuccessSta) &#123;  <span class="comment">// 所有的上传器均已完成其任务</span></span><br><span class="line">                <span class="keyword">this</span>.uploaderData.setSuccessStyle();       <span class="comment">// 设置后续样式相关，不影响逻辑理解</span></span><br><span class="line">                <span class="keyword">this</span>.uploaderData.setSuccessSta = <span class="literal">false</span>;   <span class="comment">// 设为false, 避免其他上传器重复执行接下来的操作</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化上传器的任务队列</span></span><br><span class="line"><span class="comment">     * @param &#123;Array&#125; taskQue 任务队列</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>.getTask = <span class="function">(<span class="params">taskQue</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.taskQue = taskQue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据任务队列里的任务构建formData</span></span><br><span class="line"><span class="comment">     * @param &#123;*&#125; task 任务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">this</span>.buildFormData = <span class="function">(<span class="params">task</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> file = task.file;</span><br><span class="line">        <span class="keyword">let</span> chunkSta = task.chunkSta;</span><br><span class="line">        <span class="keyword">let</span> formData = <span class="keyword">new</span> FormData();</span><br><span class="line">        formData.append(<span class="string">'fileName'</span>, file.name);   <span class="comment">// 配置一般项信息</span></span><br><span class="line">        formData.append(<span class="string">'fileId'</span>, task.fileId);</span><br><span class="line">        formData.append(<span class="string">'fileSize'</span>, file.size);</span><br><span class="line">        <span class="keyword">if</span> (chunkSta) &#123;     <span class="comment">// 分片处理配置项信息</span></span><br><span class="line">            formData.append(<span class="string">'chunkSta'</span>, chunkSta);</span><br><span class="line">            formData.append(<span class="string">'currentChunk'</span>, task.currentChunk);</span><br><span class="line">            formData.append(<span class="string">'totalChunks'</span>, task.totalChunks);</span><br><span class="line">            formData.append(<span class="string">'chunkAry'</span>, task.chunkAry)</span><br><span class="line">            formData.append(<span class="string">'data'</span>, file.slice(task.chunkData.startIndex, task.chunkData.endIndex));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            formData.append(<span class="string">'data'</span>, file);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> formData;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在对一个几百M甚至是几G的文件进行分片的时候，任务队列里面可能有成百上千的任务在等待执行，这时候我们仅仅靠一个上传器开启一个HTTP线程是远远不够的，这里我根据任务数量的不同，开启的上传器数量也不同，上面的代码中的<code>createUploader</code> 函数，如果任务队列的数量小于5个，那么我们仅启动一个上传器通过一个HTTP线程去完成；如果大于5个，那么我们则启动5个上传器有条不紊地进行工作；</p>
<p>同样的，为什么是5个而不是6/7/8/9/…个呢？因为我这里也仅仅是举一个例子，至于具体开启多少个线程去执行任务会比较合理，等有时间了再好好研究一下。</p>
<p>在这里我们还利用到了一个prototype，即原型对象，下面是我自己总结的一些相关内容：</p>
<blockquote>
<p>每创建一个函数，函数上都有一个属性prototype，它的值是一个对象，我们称之为原型对象；对于普通函数来说，该属性可能用处不是很大，但对于构造函数来说，生成实例时，该属性所指向的原型对象则会成为实例对象的原型对象，简称为原型；</p>
<p>原型对象的作用，就是定义并存放所有实例对象共享的属性和方法，这也是他被成为原型对象的原因，实例对象可以视作从原型对象衍生出来的子对象；</p>
</blockquote>
<p>那我们这里为什么要用到这个原型对象呢？</p>
<p>首先一方面，当我们开启五个上传器的时候，当某一个上传器完成了任务，它需要知道其他的上传器是否也已经完成了任务，如果均已完成执行则执行下一步操作，否则进行等待直至最后一个上传器完成任务，再执行对应的动作，所以这五个上传器理应共享这些相关的数据和信息，即其中一个上传器的状态发生改变，其他的也要同步进行更新，而我们的原型对象恰好能够满足这些条件；</p>
<p>第二个方面也是由于我前段时间刚刚总结了一下和原型对象有关的一些知识，所以便希望能够找到一个场景去应用它，毕竟学以致用；</p>
<h4 id="5-暂停-继续事件的发布和订阅"><a href="#5-暂停-继续事件的发布和订阅" class="headerlink" title="5. 暂停/继续事件的发布和订阅"></a>5. 暂停/继续事件的发布和订阅</h4><p>暂停/继续这一块，一开始我还是比较乱的，理不清思路，为什么这么说呢？当时我觉得用户的暂停/继续具有比较大的随机性，代码执行执行着突然就点暂停了，那么代码不就停止执行了吗？要怎么做到这一点呢？</p>
<p>其实我认为当时的理解有问题，用户点击暂停，他们的本意是，我希望你暂时不要再上传了，先将资源让给其他正在上传的文件或者是等我抽根烟上个厕所听首歌回来再上传，用户是希望上传这个动作暂停，而不是希望我们的代码执行暂停；</p>
<p>有读者可能会问，ajax刚准备发送某一个片段或者是某个片段正在上传了一半，用户这时候点击了暂停，这种情况要怎么处理？我个人的想法是，准备就绪将要上传的或者是正在上传中的某个片段，我们允许它们上传完，但是这一片段的进度不往前推进，即暂停进度条的更新，同时其余剩下的还未上传的块也不再上传；等到恢复上传了，我们再更新进度条，同时上传其他剩下的块；</p>
<p>当然这只是我个人的想法，如果大家有什么更好的想法也希望留言能告诉我一下，大家一起学习；</p>
<p>在这里，我还引入了一个模式——发布-订阅模式；</p>
<p>我们可以看到上面的代码中有这么几行：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> uploaderData = &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        ...</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        pauseEvent: <span class="function"><span class="keyword">function</span> (<span class="params">sta</span>) </span>&#123;</span><br><span class="line">            pauseEventSta = sta;</span><br><span class="line">            <span class="keyword">if</span> (sta) &#123;    <span class="comment">// 继续事件, 执行回调</span></span><br><span class="line">                <span class="keyword">this</span>.successFb.call(<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">ChunkUploader.prototype.uploaderData = uploaderData;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">...</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">observer.subscribe(<span class="string">'pauseEvent'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">sta</span>) </span>&#123;</span><br><span class="line">    uploaderAry.forEach(<span class="function">(<span class="params">curUploader</span>) =&gt;</span> &#123;</span><br><span class="line">        curUploader.uploaderData.pauseEvent.call(curUploader, sta)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><code>observer</code>是一个Observer对象，发布-订阅模式的简单实现如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Observer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.handlers = &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line">Observer.prototype = &#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否含有某个事件</span></span><br><span class="line"><span class="comment">     * @param &#123;string&#125;    eventType   事件名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    has: <span class="function"><span class="keyword">function</span> (<span class="params">eventType</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.handlers[eventType] ? <span class="literal">true</span> : <span class="literal">false</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 订阅事件, 注册回调函数</span></span><br><span class="line"><span class="comment">     * @param &#123;string&#125;    eventType   事件名称</span></span><br><span class="line"><span class="comment">     * @param &#123;string&#125;    handler     回调函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    subscribe: <span class="function"><span class="keyword">function</span> (<span class="params">eventType, handler</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.has(eventType)) &#123;</span><br><span class="line">            <span class="keyword">this</span>.handlers[eventType] = [];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.handlers[eventType].push(handler);</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 发布事件, 触发回调函数</span></span><br><span class="line"><span class="comment">     * @param &#123;string&#125;    eventType   事件名称</span></span><br><span class="line"><span class="comment">     * @param &#123;*&#125;         params      剩余参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    publish: <span class="function"><span class="keyword">function</span> (<span class="params">eventType, ...params</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.has(eventType)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.handlers[eventType].forEach(<span class="function"><span class="params">handler</span> =&gt;</span> &#123;</span><br><span class="line">            handler(...params);</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退订一个函数</span></span><br><span class="line"><span class="comment">     * @param &#123;string&#125;    eventType   事件名称</span></span><br><span class="line"><span class="comment">     * @param &#123;string&#125;    handler     回调函数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    offHandler: <span class="function"><span class="keyword">function</span> (<span class="params">eventType, handler</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.has(eventType))&#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> eventList = <span class="keyword">this</span>.handlers[eventType];</span><br><span class="line">        <span class="keyword">const</span> index = eventList.indexOf(handler);</span><br><span class="line">        <span class="keyword">if</span>(index &gt; <span class="number">1</span>)&#123;</span><br><span class="line">            eventList.splice(index, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退订一个事件</span></span><br><span class="line"><span class="comment">     * @param &#123;string&#125;    eventType   事件名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    offEvent: <span class="function"><span class="keyword">function</span>(<span class="params">eventType</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">this</span>.has(eventType)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.handlers[eventType] = <span class="literal">null</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 退订所有事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    offAll: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.handlers = &#123;&#125;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>: Observer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于简单演示，我这里将发布-订阅模式设计为一个事件只绑定一个操作，当然我们也可以实现为一个事件绑定多个操作，退订事件也有更好的实现；</p>
<p>这里的<code>observer</code>对象订阅的就是暂停事件：</p>
<p></p><p data-height="400" data-theme-id="0" data-slug-hash="MqJyPG" data-default-tab="result" data-user="tulyon" data-pen-title="MqJyPG" class="codepen">See the Pen <a href="https://codepen.io/tulyon/pen/MqJyPG/" target="_blank" rel="noopener">MqJyPG</a> by e2e test (<a href="https://codepen.io/tulyon" target="_blank" rel="noopener">@tulyon</a>) on <a href="https://codepen.io" target="_blank" rel="noopener">CodePen</a>.</p><p></p>
<script async src="https://static.codepen.io/assets/embed/ei.js"></script>

<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> player = <span class="built_in">document</span>.getElementById(<span class="string">'player'</span>);</span><br><span class="line"><span class="built_in">document</span>.getElementById(<span class="string">'player'</span>).onclick = clickPlayer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 点击暂停/继续</span></span><br><span class="line"><span class="comment"> * @param &#123;Event&#125; event 事件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clickPlayer</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> pauseSta = event.target.classList.contains(<span class="string">'pause'</span>);   <span class="comment">// 是否含有暂停样式</span></span><br><span class="line">    <span class="keyword">if</span> (pauseSta) &#123;    <span class="comment">// 点击则暂停</span></span><br><span class="line">        player.classList.remove(<span class="string">'pause'</span>);</span><br><span class="line">        observer.publish(<span class="string">'pauseEvent'</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;          <span class="comment">// 点击则继续</span></span><br><span class="line">        player.classList.add(<span class="string">'pause'</span>);</span><br><span class="line">        observer.publish(<span class="string">'pauseEvent'</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中，我们可以看到当点击暂停图标时，<code>observer</code>对象发布了一个 <code>pauseEvent</code> ，参数为<code>false</code> 表示暂停上传；当点击播放（继续）图标时，设置参数为true，表示恢复上传；</p>
<p>注意，由于我们开启了5个上传器，所以我们暂停的时候需要同时停止五个，恢复上传的时候也一样；</p>
<p>那么到这里，前端一些需要注意的地方也就差不多了；</p>
<p><img src="/article-img/file/sp.png" alt="">    </p>
<h2 id="后端代码实现"><a href="#后端代码实现" class="headerlink" title="后端代码实现"></a>后端代码实现</h2><p>后端我用nodeJs来实现，相比前端，后端实现得相对要简单一些：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">let</span> url = <span class="built_in">require</span>(<span class="string">'url'</span>);</span><br><span class="line"><span class="keyword">let</span> util = <span class="built_in">require</span>(<span class="string">'util'</span>);</span><br><span class="line"><span class="keyword">let</span> multiparty = <span class="built_in">require</span>(<span class="string">'multiparty'</span>);</span><br><span class="line"><span class="keyword">let</span> sha256 = <span class="built_in">require</span>(<span class="string">'js-sha256'</span>);</span><br><span class="line"><span class="keyword">let</span> FileReader = <span class="built_in">require</span>(<span class="string">'filereader'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"><span class="keyword">let</span> crypto = <span class="built_in">require</span>(<span class="string">'crypto'</span>);</span><br><span class="line"><span class="keyword">let</span> LocalStorage = <span class="built_in">require</span>(<span class="string">'node-localstorage'</span>).LocalStorage;</span><br><span class="line">localStorage = <span class="keyword">new</span> LocalStorage(<span class="string">'./scratch'</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">new</span> <span class="built_in">Date</span>() + req.method);</span><br><span class="line">    <span class="keyword">if</span> (req.method === <span class="string">'GET'</span>) &#123;         <span class="comment">//处理get请求, 查询文件指纹</span></span><br><span class="line">        res.writeHead(<span class="number">200</span>, &#123; <span class="string">'content-Type'</span>: <span class="string">'text/plain'</span>, <span class="string">"Access-Control-Allow-Origin"</span>: <span class="string">"*"</span> &#125;);</span><br><span class="line">        <span class="keyword">let</span> params = url.parse(req.url, <span class="literal">true</span>).query;</span><br><span class="line">        <span class="keyword">let</span> fileId = params.fileId;</span><br><span class="line">        <span class="keyword">let</span> fileRecord = localStorage.getItem(fileId);</span><br><span class="line">        <span class="keyword">let</span> fileExistSta = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">if</span>(fileRecord) &#123;</span><br><span class="line">            <span class="keyword">if</span>(fileRecord == <span class="string">'true'</span>) &#123;   <span class="comment">// true表示文件已经存在</span></span><br><span class="line">                fileExistSta = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;    <span class="comment">// 文件已有记录, 但是尚未完整上传</span></span><br><span class="line">                fileExistSta = <span class="built_in">JSON</span>.parse(localStorage.getItem(fileId)).chunkAry;   <span class="comment">// 记录存在, 但是不为true, 返回剩下所需要的块号</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            fileExistSta = <span class="literal">false</span>   <span class="comment">// 记录不存在表示文件需要完整上传</span></span><br><span class="line">        &#125;</span><br><span class="line">         </span><br><span class="line">        <span class="keyword">let</span> respJson = <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">            fileExistSta: fileExistSta</span><br><span class="line">        &#125;)</span><br><span class="line">        res.end(respJson);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;                <span class="comment">//处理post请求, 接收文件</span></span><br><span class="line">        <span class="keyword">let</span> path = __dirname + <span class="string">'/file-data/'</span>;</span><br><span class="line">        <span class="keyword">var</span> form = <span class="keyword">new</span> multiparty.Form(&#123; <span class="attr">encoding</span>: <span class="string">'utf-8'</span>, <span class="attr">uploadDir</span>: path &#125;);</span><br><span class="line">        form.parse(req, <span class="function"><span class="keyword">function</span> (<span class="params">err, fields, files</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (fields &amp;&amp; files) &#123;</span><br><span class="line">                <span class="keyword">let</span> currentChunk = fields.currentChunk ? fields.currentChunk[<span class="number">0</span>] : <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">let</span> totalChunks = fields.totalChunks ? fields.totalChunks[<span class="number">0</span>] : <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">let</span> newPath = totalChunks === <span class="number">1</span> ? path + files.data[<span class="number">0</span>].originalFilename : path + fields.fileId[<span class="number">0</span>] + <span class="string">'.part'</span> + currentChunk;</span><br><span class="line">                fs.rename(files.data[<span class="number">0</span>].path, newPath, <span class="function"><span class="keyword">function</span> (<span class="params">err</span>) </span>&#123;</span><br><span class="line">                    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">                        <span class="built_in">console</span>.log(<span class="string">'rename error: '</span> + err);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (totalChunks === <span class="number">1</span>) &#123;   <span class="comment">// 只有一片需要处理</span></span><br><span class="line">                        getHash(fields, files, newPath);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        chunksWorker(fields, files, newPath);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">            resFunc();</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">chunksWorker</span>(<span class="params">fields, files, newPath</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> fileId = fields.fileId[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">let</span> fileRecord = <span class="built_in">JSON</span>.parse(localStorage.getItem(fileId));    <span class="comment">// 从本地中读取文件上传的相关信息</span></span><br><span class="line">            <span class="keyword">let</span> chunkAry = fields.chunkAry[<span class="number">0</span>].split(<span class="string">','</span>);</span><br><span class="line">            deleteAryElem(chunkAry, fields.currentChunk[<span class="number">0</span>]);      <span class="comment">// 删除已经接收到的分片</span></span><br><span class="line">            <span class="keyword">if</span> (!fileRecord) &#123;    <span class="comment">// 文件尚无记录</span></span><br><span class="line">                fileRecord = &#123;</span><br><span class="line">                    fileName: fields.fileName,</span><br><span class="line">                    fileId: fileId,</span><br><span class="line">                    <span class="keyword">continue</span>: <span class="literal">true</span>,       <span class="comment">// 是否需要继续上传</span></span><br><span class="line">                    fileDir: [</span><br><span class="line">                        &#123;</span><br><span class="line">                            num: fields.currentChunk[<span class="number">0</span>],    <span class="comment">// 当前片的序号</span></span><br><span class="line">                            path: newPath                   <span class="comment">// 当前片的路径</span></span><br><span class="line">                        &#125;,</span><br><span class="line">                    ],             <span class="comment">// 已上传文件的存放路径</span></span><br><span class="line">                    loadedChunks: [fields.currentChunk[<span class="number">0</span>]],      <span class="comment">// 已上传的文件块号</span></span><br><span class="line">                    chunkAry: chunkAry         <span class="comment">// 剩下还需要上传的片</span></span><br><span class="line">                &#125;</span><br><span class="line">                localStorage.setItem(fileId, <span class="built_in">JSON</span>.stringify(fileRecord));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;    <span class="comment">// 如果已经存在记录</span></span><br><span class="line">                <span class="keyword">let</span> currentChunk = fields.currentChunk[<span class="number">0</span>];</span><br><span class="line">                fileRecord.fileDir.push(&#123; <span class="attr">num</span>: fields.currentChunk[<span class="number">0</span>], <span class="attr">path</span>: newPath &#125;);   <span class="comment">// 记录接收到的片的序号和存储路径</span></span><br><span class="line">                deleteAryElem(fileRecord.chunkAry, currentChunk);        <span class="comment">// 继续删除当前已接收到的片</span></span><br><span class="line">                <span class="keyword">let</span> loadedChunksLen = fileRecord.loadedChunks.length;</span><br><span class="line">                fileRecord.loadedChunks.push(fields.currentChunk[<span class="number">0</span>]);</span><br><span class="line">                loadedChunksLen++;</span><br><span class="line">                <span class="keyword">if</span> (loadedChunksLen === <span class="built_in">Number</span>(fields.totalChunks[<span class="number">0</span>])) &#123;   <span class="comment">// 所有的分片都已经到达</span></span><br><span class="line">                    mergeFile(fields, files, fileRecord);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    localStorage.setItem(fileId, <span class="built_in">JSON</span>.stringify(fileRecord));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">mergeFile</span>(<span class="params">fields, files, fileRecord</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> buffers = [];</span><br><span class="line">            <span class="keyword">let</span> hash = sha256.create();</span><br><span class="line">            <span class="keyword">let</span> fileDir = fileRecord.fileDir;</span><br><span class="line">            <span class="keyword">let</span> loadedChunksLen = fileRecord.loadedChunks.length;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; loadedChunksLen; i++) &#123;</span><br><span class="line">                <span class="keyword">let</span> curVal = fileDir.find(<span class="function">(<span class="params">curVal</span>) =&gt;</span> &#123;     <span class="comment">// 按顺序寻找文件块</span></span><br><span class="line">                    <span class="keyword">if</span> (<span class="built_in">Number</span>(curVal.num) === i) &#123;</span><br><span class="line">                        <span class="keyword">return</span> curVal;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">let</span> buffer = fs.readFileSync(curVal.path);    <span class="comment">// 读取文件</span></span><br><span class="line">                hash.update(buffer);     <span class="comment">// 更新sha256</span></span><br><span class="line">                buffers.push(buffer);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">let</span> newName = path + fileRecord.fileName;</span><br><span class="line">            <span class="keyword">let</span> concaBuffer = Buffer.concat(buffers);</span><br><span class="line">            fs.writeFile(newName, concaBuffer);      <span class="comment">// 写入文件</span></span><br><span class="line">            <span class="keyword">if</span> (fileRecord.fileId === hash.hex()) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(hash.hex());</span><br><span class="line">                fileDir.forEach(<span class="function">(<span class="params">curval</span>) =&gt;</span> &#123;</span><br><span class="line">                    fs.unlink(curval.path);     <span class="comment">// 删除临时文件</span></span><br><span class="line">                &#125;);</span><br><span class="line">                localStorage.setItem(fileRecord.fileId, <span class="literal">true</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">getHash</span>(<span class="params">fields, files, newPath</span>) </span>&#123;</span><br><span class="line">            <span class="comment">// 后端重新计算文件指纹</span></span><br><span class="line">            <span class="keyword">let</span> stream = fs.createReadStream(newPath);</span><br><span class="line">            <span class="keyword">let</span> hash = sha256.create();</span><br><span class="line">            stream.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">d</span>) </span>&#123;</span><br><span class="line">                hash.update(d);   <span class="comment">// 更新sha256 </span></span><br><span class="line">            &#125;);</span><br><span class="line"></span><br><span class="line">            stream.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">                <span class="keyword">let</span> fileId = hash.hex();</span><br><span class="line">                <span class="keyword">if</span> (fileId === fields.fileId[<span class="number">0</span>]) &#123;    <span class="comment">// 与前端的文件指纹相匹对, 校验文件完整性</span></span><br><span class="line">                    <span class="comment">// 存在本地</span></span><br><span class="line">                    <span class="built_in">console</span>.log(fileId)</span><br><span class="line">                    localStorage.setItem(fileId, <span class="string">'true'</span>)</span><br><span class="line">                    resFunc();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">deleteAryElem</span>(<span class="params">ary, elem</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> index = ary.indexOf(elem);</span><br><span class="line">            <span class="keyword">if</span> (index === <span class="number">-1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            ary.splice(index, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">resFunc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">            <span class="keyword">let</span> respJson = <span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                code: <span class="number">1000</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">            res.writeHead(<span class="number">200</span>, &#123; <span class="string">'Content-Type'</span>: <span class="string">'text/html'</span>, <span class="string">"Access-Control-Allow-Origin"</span>: <span class="string">"*"</span> &#125;);</span><br><span class="line">            res.end(respJson);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).listen(<span class="number">3000</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'server is listening on "3000"'</span>);</span><br></pre></td></tr></table></figure>
<p>后端我采用了<a href="https://www.bootcdn.cn/js-sha256/" target="_blank" rel="noopener">multiparty </a>来接收文件，合并文件我采取的方法是，等所有文件到达之后，再按顺序读取写入，这个方法在面对大文件时，成千上万的文件碎片在等待合并，就会显得十分的缓慢；那么我也思考了一个优化方案，不过暂时还没有时间去仔细研究验证：</p>
<ul>
<li>边上传边合并，来一片合并一片，如果先来的是后面的文件碎片，如2号文件碎片比1号文件碎片先到达，那么往1号文件碎片的位置填充入同样大小的内容来占位，然后写入2号碎片文件，等1号碎片到达之后，再将1号碎片的内容写入对应的占位空间；</li>
</ul>
<p>那么到这里，前后端的实现都已基本讲解完毕；</p>
<p><img src="/article-img/file/sp.png" alt="">    </p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>这篇文章总结了我个人在实现大文件上传时的一些学习思路以及所遇到的难点；大文件上传这个东西，我个人觉得还是挺有趣的，不过我上面所实现的功能也都比较基础，而且也还有很多可以扩展的东西继续探究下去。</p>
<p>最后如果文章中有什么地方表述不清楚或者理解错误的地方，希望大家给我留言指出我的错误，我也会及时更正文章，以更好地和大家一起学习进步，同时也希望这篇文章能够帮到一些在学习中和我有同样疑问的同学。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li><a href="https://blog.csdn.net/zengzm163/article/details/50539854" target="_blank" rel="noopener">居于H5的多文件、大文件、多线程上传解决方案</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob/slice" target="_blank" rel="noopener">Blob对象</a> </li>
<li><a href="https://www.zhuwenlong.com/blog/article/52d6769f93dcae3050000003" target="_blank" rel="noopener">HTML5 file api 读取文件MD5码</a></li>
<li><a href="https://www.zhangxinxu.com/wordpress/2013/11/xmlhttprequest-ajax-localstorage-%E6%96%87%E4%BB%B6%E6%96%AD%E7%82%B9%E7%BB%AD%E4%BC%A0/" target="_blank" rel="noopener">XMLHttpRequest实现HTTP协议下文件上传断点续传</a> </li>
<li><a href="https://juejin.im/post/599804e1f265da24934aeee7" target="_blank" rel="noopener">无插件实现大文件分片上传，断点续传</a></li>
</ol>

            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="true">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        <li title='0' data-url='http://96.ierge.cn/12/193/386484.mp3'></li>
                    
                        <li title='1' data-url='http://96.ierge.cn/12/193/386484.mp3'></li>
                    
                </ul>
            
        </div>
        
    <div id='gitalk-container' class="comment link"
        data-ae='true'
        data-ci='a26a05530183d2e79aa9'
        data-cs='c2af8561ca91dddff6b07ed0a55429dc2e230f60'
        data-r='Tulyon.github.io'
        data-o='Tulyon'
        data-a='Tulyon'
        data-d='false'
    >查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>
<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/diaspora.js"></script>
<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">
<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>

<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>




</html>